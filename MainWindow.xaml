<!-- File: /MainWindow.xaml -->
<Window x:Class="LegendBorn.MainWindow"
        x:Name="RootWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:shell="clr-namespace:System.Windows.Shell;assembly=PresentationFramework"
        xmlns:tabs="clr-namespace:LegendBorn.Views.Tabs"
        Title="LegendBorn"
        Icon="pack://application:,,,/Resources/Assets/logolauncher.png"
        Width="1100" Height="740"
        MinWidth="920" MinHeight="600"
        WindowStartupLocation="CenterScreen"
        Background="#0B0F1A"
        Foreground="#EAF0FF"
        FontFamily="Segoe UI"
        WindowStyle="None"
        ResizeMode="NoResize"
        SnapsToDevicePixels="True"
        UseLayoutRounding="True"
        TextOptions.TextFormattingMode="Display"
        TextOptions.TextRenderingMode="ClearType">

    <shell:WindowChrome.WindowChrome>
        <shell:WindowChrome CaptionHeight="0"
                            CornerRadius="16"
                            GlassFrameThickness="0"
                            ResizeBorderThickness="0"
                            UseAeroCaptionButtons="False"/>
    </shell:WindowChrome.WindowChrome>

    <!-- ВАЖНО:
         Ресурсы (LauncherTheme + MainWindowLocal) теперь подключены в App.xaml.
         Здесь Window.Resources НЕ нужны и НЕ должны дублировать словари.
    -->

    <Border x:Name="RootBorder">
        <Border.Style>
            <Style TargetType="Border" BasedOn="{StaticResource RootBorderStyle}">
                <Style.Triggers>
                    <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=Window}, Path=WindowState}"
                                 Value="Maximized">
                        <Setter Property="CornerRadius" Value="0"/>
                        <Setter Property="Margin" Value="0"/>
                    </DataTrigger>
                </Style.Triggers>
            </Style>
        </Border.Style>

        <Grid>

            <!-- Background -->
            <Grid>
                <Rectangle>
                    <Rectangle.Fill>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                            <GradientStop Color="#060718" Offset="0"/>
                            <GradientStop Color="#0B0F1A" Offset="1"/>
                        </LinearGradientBrush>
                    </Rectangle.Fill>
                </Rectangle>

                <Ellipse Width="560" Height="560"
                         Opacity="0.10"
                         HorizontalAlignment="Left"
                         Margin="-180,-180,0,0">
                    <Ellipse.Fill>
                        <RadialGradientBrush>
                            <GradientStop Color="#A855F7" Offset="0"/>
                            <GradientStop Color="#00A855F7" Offset="1"/>
                        </RadialGradientBrush>
                    </Ellipse.Fill>
                </Ellipse>

                <Ellipse Width="640" Height="640"
                         Opacity="0.08"
                         HorizontalAlignment="Right"
                         Margin="0,-240,-240,0">
                    <Ellipse.Fill>
                        <RadialGradientBrush>
                            <GradientStop Color="#7C3AED" Offset="0"/>
                            <GradientStop Color="#007C3AED" Offset="1"/>
                        </RadialGradientBrush>
                    </Ellipse.Fill>
                </Ellipse>
            </Grid>

            <Grid Margin="16">
                <Grid.RowDefinitions>
                    <RowDefinition Height="52"/>
                    <RowDefinition Height="14"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- TopBar -->
                <Border Grid.Row="0" Style="{StaticResource TopBarStyle}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Brand -->
                        <Button Grid.Column="0"
                                Style="{StaticResource BrandButtonStyle}"
                                ToolTip="Главная"
                                Command="{Binding OpenStartCommand}">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <Border Width="34" Height="34"
                                        CornerRadius="12"
                                        Background="#22FFFFFF"
                                        VerticalAlignment="Center">
                                    <Image Source="pack://application:,,,/Resources/Assets/logolauncher.png"
                                           Stretch="Uniform"
                                           Margin="5"
                                           RenderOptions.BitmapScalingMode="HighQuality"/>
                                </Border>

                                <StackPanel Margin="12,0,0,0">
                                    <TextBlock Text="LEGENDBORN"
                                               FontWeight="SemiBold"
                                               FontSize="12"
                                               Foreground="{StaticResource TextStrongLocal}"/>

                                    <StackPanel Orientation="Horizontal" Opacity="0.80">
                                        <TextBlock Text="Launcher"
                                                   Foreground="{StaticResource TextDim}"
                                                   FontSize="11"/>
                                        <TextBlock Text="  •  "
                                                   Foreground="{StaticResource TextDim}"
                                                   FontSize="11"/>
                                        <TextBlock Text="{Binding LauncherVersion}"
                                                   Foreground="{StaticResource TextDim}"
                                                   FontSize="11"/>
                                    </StackPanel>
                                </StackPanel>
                            </StackPanel>
                        </Button>

                        <!-- Drag area -->
                        <Border Grid.Column="1"
                                Background="Transparent"
                                MouseLeftButtonDown="TitleBar_OnMouseLeftButtonDown"/>

                        <!-- Right controls -->
                        <StackPanel Grid.Column="2"
                                    Orientation="Horizontal"
                                    VerticalAlignment="Center">

                            <Button Style="{StaticResource NewsTopButtonStyle}"
                                    ToolTip="Новости"
                                    Click="OpenNewsTab_OnClick">
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <Viewbox Width="16" Height="16" Margin="0,0,8,0">
                                        <Canvas Width="16" Height="16">
                                            <Rectangle Width="14" Height="14" Canvas.Left="1" Canvas.Top="1"
                                                       RadiusX="2" RadiusY="2"
                                                       Stroke="{StaticResource TextDimLocal}"
                                                       StrokeThickness="1"
                                                       Opacity="0.9"/>
                                            <Rectangle Width="4" Height="5" Canvas.Left="3" Canvas.Top="4"
                                                       Stroke="{StaticResource TextDimLocal}"
                                                       StrokeThickness="1"
                                                       Opacity="0.9"/>
                                            <Line X1="8" Y1="5" X2="13" Y2="5"
                                                  Stroke="{StaticResource TextDimLocal}"
                                                  StrokeThickness="1"
                                                  Opacity="0.9"/>
                                            <Line X1="8" Y1="7" X2="13" Y2="7"
                                                  Stroke="{StaticResource TextDimLocal}"
                                                  StrokeThickness="1"
                                                  Opacity="0.9"/>
                                            <Line X1="3" Y1="11" X2="13" Y2="11"
                                                  Stroke="{StaticResource TextDimLocal}"
                                                  StrokeThickness="1"
                                                  Opacity="0.9"/>
                                        </Canvas>
                                    </Viewbox>

                                    <TextBlock Text="Новости"
                                               Foreground="{StaticResource TextStrongLocal}"
                                               VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>

                            <Button Style="{StaticResource ProfileButton}"
                                    Margin="0,0,10,0"
                                    Visibility="{Binding IsLoggedIn, Converter={StaticResource BoolToVis}}"
                                    Command="{Binding OpenProfileCommand}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="8"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <Border Width="24" Height="24"
                                            CornerRadius="10"
                                            ClipToBounds="True"
                                            Background="#24324B">
                                        <Grid>
                                            <TextBlock Text="{Binding UserInitial}"
                                                       FontWeight="Bold"
                                                       FontSize="12"
                                                       Foreground="{StaticResource TextStrongLocal}"
                                                       HorizontalAlignment="Center"
                                                       VerticalAlignment="Center"/>
                                            <Image Source="{Binding AvatarUrl, IsAsync=True}"
                                                   Stretch="UniformToFill"/>
                                        </Grid>
                                    </Border>

                                    <TextBlock Grid.Column="2"
                                               Text="{Binding SiteUserName}"
                                               Foreground="{StaticResource TextStrongLocal}"
                                               VerticalAlignment="Center"/>

                                    <TextBlock Grid.Column="3"
                                               Margin="8,0,0,0"
                                               Foreground="{StaticResource TextDim}"
                                               Text="▾"
                                               VerticalAlignment="Center"/>
                                </Grid>

                                <Button.ContextMenu>
                                    <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                                        <MenuItem Header="{Binding Rezonite, StringFormat=Резонит: {0:N0}}"
                                                  IsEnabled="False"/>
                                        <Separator/>
                                        <MenuItem Header="Профиль" Command="{Binding OpenProfileCommand}"/>
                                        <Separator/>
                                        <MenuItem Header="Выйти" Command="{Binding SiteLogoutCommand}"/>
                                    </ContextMenu>
                                </Button.ContextMenu>
                            </Button>

                            <!-- ✅ Настройки: toggle -->
                            <Button Style="{StaticResource WinCtlButton}"
                                    ToolTip="Настройки"
                                    Click="OpenSettingsTab_OnClick">
                                <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE713;" FontSize="14"/>
                            </Button>

                            <Button Style="{StaticResource WinCtlButton}"
                                    ToolTip="Свернуть"
                                    Click="Minimize_OnClick">
                                <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE921;" FontSize="14"/>
                            </Button>

                            <Button Style="{StaticResource WinCtlButton}"
                                    ToolTip="Закрыть"
                                    Click="Close_OnClick">
                                <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE8BB;" FontSize="14"/>
                            </Button>

                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Tabs -->
                <TabControl x:Name="MainTabs"
                            Grid.Row="2"
                            Style="{StaticResource HiddenTabsStyle}"
                            Focusable="False"
                            KeyboardNavigation.TabNavigation="None"
                            SelectedIndex="{Binding SelectedMenuIndex, Mode=TwoWay}">

                    <TabItem>
                        <tabs:AuthTabView/>
                    </TabItem>

                    <TabItem>
                        <tabs:StartTabView/>
                    </TabItem>

                    <TabItem>
                        <tabs:ProfileTabView/>
                    </TabItem>

                    <TabItem>
                        <tabs:SettingsTabView/>
                    </TabItem>

                    <TabItem>
                        <tabs:NewsTabView/>
                    </TabItem>

                </TabControl>

            </Grid>
        </Grid>
    </Border>
</Window>
